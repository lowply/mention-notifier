AWSTemplateFormatVersion: '2010-09-09'
Description: MentionNotifier
Resources:
  MentionNotifierFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: <%= configy['BUCKET'] %>
        S3Key: !Sub ${AWS::StackName}/main.zip
      Description: !Sub https://github.com/lowply/${AWS::StackName}
      Environment:
        Variables:
          LOGIN: <%= config['LOGIN'] %>
          GITHUB_TOKEN: <%= config['GITHUB_TOKEN'] %>
          SLACK_ENDPOINT: <%= config['SLACK_ENDPOINT'] %>
          GITHUB_ENDPOINT: <%= config['GITHUB_ENDPOINT'] %>
          REASON: <%= config['REASON'] %>
          POLLING: '<%= config['POLLING'] %>'
      FunctionName: !Sub ${AWS::StackName}
      Handler: main
      Role: !GetAtt MentionNotifierRole.Arn
      Runtime: go1.x
  MentionNotifierPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub ${AWS::StackName}
      Principal: events.amazonaws.com
      SourceArn: !GetAtt MentionNotifierRule.Arn
  MentionNotifierRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: '2012-10-17'
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Path: /service-role/
      RoleName: !Sub ${AWS::StackName}
  MentionNotifierRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Run mention notifier every minute
      Name: !Sub ${AWS::StackName}
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
      - Arn: !GetAtt MentionNotifierFunction.Arn
        Id: !Sub ${AWS::StackName}
